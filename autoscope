#!/bin/bash

# --- HELPER FUNCTIONS ---

usage() {
    echo "Usage: $(basename "$0") [gamescope options] -- [command]"
    echo "Example: $(basename "$0") -w 1920 -h 1080 -- %command%"
    exit 1
}

# 0. Check dependencies
for cmd in xrandr gamescope awk grep find; do
    if ! command -v $cmd &> /dev/null; then
        echo "Error: '$cmd' is not installed."
        exit 1
    fi
done

if [ $# -eq 0 ]; then usage; fi
if [[ "$1" == "-h" || "$1" == "--help" ]]; then usage; fi


# --- CHECK FOR USER OVERRIDES ---

# We scan your arguments to see if you are manually setting Output Resolution (-W / -H)
user_override=false
for arg in "$@"; do
    if [[ "$arg" == "-W" || "$arg" == "-H" ]]; then
        user_override=true
        break
    fi
done


# --- RESOLUTION DETECTION ---

# Only bother detecting hardware if the user isn't overriding it
if [ "$user_override" = false ]; then
    echo "üîç Detecting display configuration..."

    # 1. Get Primary Display
    xrandr_name=$(xrandr | grep " connected primary" | awk '{print $1}')
    if [ -z "$xrandr_name" ]; then
        xrandr_name=$(xrandr | grep " connected" | head -n 1 | awk '{print $1}')
    fi

    # 2. Find Kernel Mode
    if [ -n "$xrandr_name" ]; then
        clean_name=$(echo "$xrandr_name" | sed 's/-A-/-/g')
        modes_file=$(find /sys/class/drm -name "*${xrandr_name}" -o -name "*${clean_name}" 2>/dev/null | grep "/modes$" | head -n 1)
        
        if [ -z "$modes_file" ]; then
            sys_folder=$(find /sys/class/drm -name "*${xrandr_name}" 2>/dev/null | head -n 1)
            if [ -n "$sys_folder" ]; then modes_file="${sys_folder}/modes"; fi
        fi
    fi

    # 3. Set Variables
    if [ -f "$modes_file" ]; then
        raw_res=$(head -n 1 "$modes_file")
        w=$(echo "$raw_res" | cut -d'x' -f1)
        h=$(echo "$raw_res" | cut -d'x' -f2)
        echo "‚úÖ Native Resolution: ${w}x${h}"
    else
        echo "‚ö†Ô∏è Detection failed. Defaulting to 1920x1080."
        w=1920
        h=1080
    fi
else
    echo "‚ö†Ô∏è User Override Detected: Skipping auto-resolution."
fi

# --- EXECUTION ---

echo "üöÄ Launching Gamescope..."
echo "-------------------------------------"

if [ "$user_override" = false ]; then
    # Standard Mode: We enforce native output (-W -H)
    gamescope -f --force-grab -W "$w" -H "$h" "$@"
else
    # Override Mode: We DO NOT add -W or -H. We trust your arguments in "$@"
    gamescope -f --force-grab "$@"
fi
